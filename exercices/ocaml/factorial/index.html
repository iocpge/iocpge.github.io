<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Factorielle</title>
    <link rel="stylesheet" href="/codemirror.css">
    <link rel="stylesheet" href="/ocaml-style.css">
    <link rel="stylesheet" href="/material-palenight.css">
    <link rel="stylesheet" href="/katex.min.css">
</head>
<body>

    <script src="/codemirror.js"></script>
    <script src="/matchbrackets.js"></script>
    <script src="/closebrackets.min.js"></script>
    <script src="/mllike.js"></script>
    <script src="/toplevel.js"></script> 


<div class="exercise-container">
    <div class="panel left-panel">
        <h1>Factorielle</h1>
        <div class="instructions">
            <h2>Énoncé</h2>
<p>Écrivez une fonction <code>factorielle</code> qui prend un entier <code>n</code> et renvoie sa factorielle (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>!</mo></mrow><annotation encoding="application/x-tex">n!</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span><span class="mclose">!</span></span></span></span>).</p>
<p>Rappel :</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn><mo>!</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">0! = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">0</span><span class="mclose">!</span><span class="mrel">=</span><span class="mord mathrm">1</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>!</mo><mo>=</mo><mi>n</mi><mo>×</mo><mo>(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo>)</mo><mo>!</mo></mrow><annotation encoding="application/x-tex">n! = n \times (n-1)!</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span><span class="mclose">!</span><span class="mrel">=</span><span class="mord mathit">n</span><span class="mbin">×</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mbin">−</span><span class="mord mathrm">1</span><span class="mclose">)</span><span class="mclose">!</span></span></span></span> pour <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">n &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span><span class="mrel">&gt;</span><span class="mord mathrm">0</span></span></span></span></li>
</ul>
<p>Vérifiez votre code en l'exécutant. Le test final affichera le résultat pour 5 (qui doit être 120).</p>

        </div>
        
        
        <details>
            <summary>Indice</summary>
            <p>Pensez au cas de base : si n est 0 ou 1, la réponse est 1. Sinon, c&#39;est n * f(n-1).</p>
        </details>
        

        
        <details>
            <summary>Solution</summary>
            <pre><code>let rec fact n =
  if n &lt;= 1 then 1
  else n * fact (n - 1)
</code></pre>
        </details>
        
    </div>
    <div class="main-content-area">
      <div class="panel center-panel" style="padding:0;">
          <div class="editor-toolbar">
              <button id="run-btn">Exécuter ▶</button>
              <button id="reset-btn">Réinitialiser</button>
          </div>
          <textarea id="code-editor">let rec fact n =
  (* Votre code ici *)
 ;;    

(* tests *)
 fact 5;;
</textarea>
        </div>

      <div class="panel bottom-panel">
          <div class="output-log" id="output">Initialisation OCaml... Lancer l'évalution !</div>
      </div>
    </div>
</div>


<script>
  function lancerExecution() {
    outputDiv.innerHTML = '';
    clearErrors(); // On nettoie les erreurs précédentes
    
    // "editor" est accessible ici car déclaré plus haut
    var code = editor.getValue(); 
    
    if (window.ocaml && window.ocaml.run) {
        try {
            var result = window.ocaml.run(code);
            if(result && result.trim() !== "") {
                var el = document.createElement('div');
                el.textContent = result;
                el.className = 'success';
                outputDiv.appendChild(el);
                outputDiv.scrollTop = outputDiv.scrollHeight;
            }
        } catch (e) {
            console.error(e);
            window.ocaml_log('stderr', "Erreur interne JS: " + e.message);
        }
    } else {
        window.ocaml_log('stderr', "Le compilateur OCaml n'est pas encore chargé...");
    }
  };

    var outputDiv =  document.getElementById('output');

    var editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
        mode: 'text/x-ocaml',
        lineNumbers: true,
        matchBrackets: true,
        autoCloseBrackets: true, 
        theme: 'material-palenight',
        extraKeys: {  
            "Shift-Enter": function(cm) {
                lancerExecution(); 
             }
         }
    }
    );

    var runBtn = document.getElementById('run-btn');
    
    // Variable pour stocker les marqueurs d'erreurs actuels
    var errorMarks = [];

    // Fonction pour nettoyer les soulignements précédents
    function clearErrors() {
        errorMarks.forEach(mark => mark.clear());
        errorMarks = [];
    }

function highlightError(msg) {
    // AFFICHER LE MESSAGE REÇU DANS LA CONSOLE (F12)
    console.log("Message d'erreur reçu pour analyse :", msg);

    // Regex améliorée :
    // 1. Le 'i' à la fin la rend insensible à la casse (Line vs line)
    // 2. \s+ permet de gérer un ou plusieurs espaces
    var regex = /line\s+(\d+),\s+characters\s+(\d+)-(\d+)/i;
    
    var match = msg.match(regex);

    if (match) {
        console.log("Match trouvé !", match); // Debug

        var line = parseInt(match[1], 10) - 1; // Ligne (base 0)
        var chStart = parseInt(match[2], 10);  // Début
        var chEnd = parseInt(match[3], 10);    // Fin

        console.log("Tentative de soulignement : Ligne", line, "Cols", chStart, "à", chEnd);

        // Vérification de sécurité pour ne pas planter si la ligne n'existe pas
        if (line < 0 || line >= editor.lineCount()) {
            console.warn("Ligne hors limites pour l'éditeur");
            return;
        }

        var mark = editor.markText(
            {line: line, ch: chStart},
            {line: line, ch: chEnd},
            {
                className: "cm-error-underline",
                title: msg,
                clearOnEnter: true
            }
        );
        errorMarks.push(mark);
    } else {
        console.warn("Aucun match regex trouvé dans le message d'erreur.");
    }
}

    window.ocaml_log = function(type, msg) {
        if (!msg || msg.trim() === "") return;
        
        // Si c'est une erreur (stderr), on tente de la souligner dans l'éditeur
        if (type === 'stderr') {
            highlightError(msg);
        }

        var el = document.createElement('div');
        el.textContent = msg;
        el.className = (type === 'stderr') ? 'error' : 'info';
        
        outputDiv.appendChild(el);
        outputDiv.scrollTop = outputDiv.scrollHeight;
    };

    runBtn.addEventListener('click',  lancerExecution);
</script>

</body>
</html>
