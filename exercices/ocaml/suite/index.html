<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suite</title>
    <link rel="stylesheet" href="/codemirror.css">
    <link rel="stylesheet" href="/ocaml-style.css">
    <link rel="stylesheet" href="/material-palenight.css">
</head>
<body>

    <script src="/codemirror.js"></script>
    <script src="/matchbrackets.js"></script>
    <script src="/closebrackets.min.js"></script>
    <script src="/mllike.js"></script>
    <script src="/toplevel.js"></script> 


<div class="exercise-container">
    <div class="panel left-panel">
        <h1>Suite</h1>
        <div class="instructions">
            <h2>Énoncé</h2>
<p>Écrivez une fonction <code>factorielle</code> qui prend un entier <code>n</code> et renvoie sa factorielle (<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>!</mo></mrow><annotation encoding="application/x-tex">n!</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span><span class="mclose">!</span></span></span></span>).</p>
<p>Rappel :</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn><mo>!</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">0! = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">0</span><span class="mclose">!</span><span class="mrel">=</span><span class="mord mathrm">1</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>!</mo><mo>=</mo><mi>n</mi><mo>×</mo><mo>(</mo><mi>n</mi><mo>−</mo><mn>1</mn><mo>)</mo><mo>!</mo></mrow><annotation encoding="application/x-tex">n! = n \times (n-1)!</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span><span class="mclose">!</span><span class="mrel">=</span><span class="mord mathit">n</span><span class="mbin">×</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mbin">−</span><span class="mord mathrm">1</span><span class="mclose">)</span><span class="mclose">!</span></span></span></span> pour <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">n &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span><span class="mrel">&gt;</span><span class="mord mathrm">0</span></span></span></span></li>
</ul>
<p>Vérifiez votre code en l'exécutant. Le test final affichera le résultat pour 5 (qui doit être 120).</p>

        </div>
        
        
        <details>
            <summary>Indice</summary>
            <p>Penser à la programmation impérative en Python</p>
        </details>
        

        
        <details>
            <summary>Solution</summary>
            <pre><code>let next terme = terme + 1;;

let u_imp_for u0 n =
  let terme = ref u0 in
  for rang = 1 to n do
    terme := next !terme
  done;
  !terme;;

let u_imp_while u0 n =
  let terme = ref u0 in
  let rang = ref 0 in
  while !rang &lt; n do
    terme := next !terme;
    incr rang (* identique à rang := !rang + 1 *)
  done;
  !rang;;

let rec u u0 n = if n = 0 then u0 else u u0 (n - 1) + 1;;

for i = 0 to 10 do
  Printf.printf &quot;test rang --&gt; %d&#92;n&quot; i;
  assert (u 0 i = u_imp_for 0 i);
  assert (u 0 i = u_imp_while 0 i)
done;;
</code></pre>
        </details>
        
    </div>
    <div class="main-content-area">
      <div class="panel center-panel" style="padding:0;">
          <div class="editor-toolbar">
              <button id="run-btn">Exécuter ▶</button>
              <button id="reset-btn">Réinitialiser</button>
          </div>
          <textarea id="code-editor">let next terme = (* TODO *);;

let u_imp_for u0 n = 0 (* TODO *);;

let rec u u0 n = 0 (*  TODO *);;

for i = 0 to 10 do
  Printf.printf &quot;test rang --&gt; %d&#92;n&quot; i;
  assert (u 0 i = u_imp_for 0 i);
  assert (u 0 i = u_imp_while 0 i)
done;;
</textarea>
        </div>

      <div class="panel bottom-panel">
          <div class="output-log" id="output">Initialisation OCaml... Lancer l'évalution !</div>
      </div>
    </div>
</div>


<script>
    var outputDiv =  document.getElementById('output');

    var editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
        mode: 'text/x-ocaml',
        lineNumbers: true,
        matchBrackets: true,
        autoCloseBrackets: true, 
        theme: 'material-palenight',
        extraKeys: {  
            "Shift-Enter": function(cm) {
                runCode(); 
            }
    });

    var runBtn = document.getElementById('run-btn');
    
    // Variable pour stocker les marqueurs d'erreurs actuels
    var errorMarks = [];

    // Fonction pour nettoyer les soulignements précédents
    function clearErrors() {
        errorMarks.forEach(mark => mark.clear());
        errorMarks = [];
    }

    // Fonction pour analyser le texte d'erreur OCaml et souligner
    function highlightError(msg) {
        // Regex pour capturer: "line X, characters Y-Z"
        // Le format standard OCaml est souvent: File "...", line 2, characters 4-15:
        var regex = /line (\d+), characters (\d+)-(\d+)/;
        var match = msg.match(regex);

        // pour éviter un crash JS si l'erreur pointe vers une ligne supprimée
        if (line >= editor.lineCount()) return;

        if (match) {
            // OCaml compte les lignes à partir de 1, CodeMirror à partir de 0 -> on fait -1
            var line = parseInt(match[1], 10) - 1;
            var chStart = parseInt(match[2], 10);
            var chEnd = parseInt(match[3], 10);

            // Création du marqueur
            var mark = editor.markText(
                {line: line, ch: chStart},
                {line: line, ch: chEnd},
                {
                    className: "cm-error-underline",
                    title: msg, // Affiche l'erreur au survol de la souris
                    clearOnEnter: true // Efface le soulignement dès que l'élève modifie la zone
                }
            );
            errorMarks.push(mark);
        }
    }

    window.ocaml_log = function(type, msg) {
        if (!msg || msg.trim() === "") return;
        
        // Si c'est une erreur (stderr), on tente de la souligner dans l'éditeur
        if (type === 'stderr') {
            highlightError(msg);
        }

        var el = document.createElement('div');
        el.textContent = msg;
        el.className = (type === 'stderr') ? 'error' : 'info';
        
        outputDiv.appendChild(el);
        outputDiv.scrollTop = outputDiv.scrollHeight;
    };

    runBtn.addEventListener('click', function() {
        outputDiv.innerHTML = '';
        clearErrors(); // On nettoie les erreurs précédentes avant de relancer
        
        var code = editor.getValue();
        
        if (window.ocaml && window.ocaml.run) {
            try {
                var result = window.ocaml.run(code);
                if(result && result.trim() !== "") {
                    var el = document.createElement('div');
                    el.textContent = result;
                    el.className = 'success';
                    outputDiv.appendChild(el);
                    outputDiv.scrollTop = outputDiv.scrollHeight;
                }
            } catch (e) {
                console.error(e);
                window.ocaml_log('stderr', "Erreur interne JS: " + e.message);
            }
        } else {
            window.ocaml_log('stderr', "Le compilateur OCaml n'est pas encore chargé...");
        }
    });
</script>

</body>
</html>
